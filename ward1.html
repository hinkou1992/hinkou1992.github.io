<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>病房交車廣播</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    /* 頁首區塊 */
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #333;
    }
    #datetime {
      font-size: 1.1em;
    }
    #adminToggle {
      padding: 5px 10px;
      background-color: #555;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    /* 管理者面板 */
    #adminPanel {
      padding: 10px;
      background-color: #444;
      display: none;
    }
    #adminPanel input[type="text"] {
      padding: 5px;
      border: none;
      border-radius: 3px;
    }
    #adminPanel button {
      padding: 5px 10px;
      margin-left: 5px;
      background-color: #666;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    #adminPanel label {
      margin-right: 10px;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
    }
    /* 兩排樓層容器 */
    .floor-rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }
    .floor-row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .floor-column {
      flex: 1;
      min-width: 120px;
      background-color: #222;
      border-radius: 8px;
      padding: 10px;
    }
    .floor-column h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 50px;
    }
    /* 房間容器：左側 ready 按鈕、右側交車按鈕 */
    .room-container {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    /* 左側 ready 按鈕 */
    .ready-btn {
      padding: 10px;
      font-size: 0.8em;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      min-width: 70px;
    }
    .ready-btn:hover {
      opacity: 0.8;
    }
    /* 右側交車按鈕 */
    .room-btn {
      flex: 1;
      padding: 10px;
      font-size: 0.9em;
      border: none;
      border-radius: 5px;
      color: white;
      text-align: left;
      cursor: move;
      position: relative;
    }
    .room-btn:hover {
      opacity: 0.8;
    }
    /* 管理模式下的刪除按鈕 */
    .remove-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background-color: red;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 16px;
      text-align: center;
      cursor: pointer;
      font-size: 0.8em;
      display: none;
    }
    /* 管理模式下的編輯按鈕 */
    .edit-btn {
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
      background-color: orange;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 16px;
      text-align: center;
      cursor: pointer;
      font-size: 0.8em;
      display: none;
    }
    .admin .remove-btn,
    .admin .edit-btn {
      display: block;
    }
  </style>
</head>
<body>
  <!-- 頁首：左上顯示日期與時間，右上切換管理者模式 -->
  <div id="header">
    <div id="datetime"></div>
    <button id="adminToggle">管理者模式</button>
  </div>
  <!-- 管理者面板：新增病房、重設所有病房、自動重設選項 -->
  <div id="adminPanel">
    <label for="newRoom">新增病房（請輸入完整房號，如 2B1）：</label>
    <input type="text" id="newRoom" placeholder="例如：2B1">
    <button id="addRoomBtn">新增病房</button>
    <button id="resetAllBtn">重設所有病房</button>
    <br><br>
    <label>
      <input type="checkbox" id="autoResetCheckbox">
      隔日自動回復所有病房狀態
    </label>
  </div>

  <h1>病房交車廣播</h1>

  <!-- 病房區塊，分成上下兩排 -->
  <div class="floor-rows" id="floorRows">
    <!-- 樓層欄位會由 JavaScript 動態生成 -->
  </div>

  <!-- 使用 ES6 模組引入 Firebase SDK 與 Realtime Database -->
  <script type="module">
    // 引入 Firebase SDK 模組
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyBR0j6SN0_C2I_UJjgF_AyspTKituMAlaU",
      authDomain: "ward-8832a.firebaseapp.com",
      projectId: "ward-8832a",
      storageBucket: "ward-8832a.firebasestorage.app",
      messagingSenderId: "516288590480",
      appId: "1:516288590480:web:20e1ee048bf2342c381e15",
      measurementId: "G-YHW57G4J7B"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    /********** Firebase 同步區 **********/
    // 參考節點：roomStatus, roomGroups, settings
    const roomStatusRef = ref(db, 'roomStatus');
    const roomGroupsRef = ref(db, 'roomGroups');
    const settingsRef = ref(db, 'settings');

    // 全域變數：房間狀態、房間排序、設定
    let roomStatus = {};
    let roomGroups = {};
    let settings = {};

    // 監聽 Firebase 中 roomStatus、roomGroups、settings 變化
    onValue(roomStatusRef, (snapshot) => {
      roomStatus = snapshot.val() || {};
      renderFloors();
    });
    onValue(roomGroupsRef, (snapshot) => {
      roomGroups = snapshot.val() || getDefaultGroup();
      renderFloors();
    });
    onValue(settingsRef, (snapshot) => {
      settings = snapshot.val() || { autoResetEnabled: false, lastResetDate: "" };
      document.getElementById("autoResetCheckbox").checked = settings.autoResetEnabled;
      checkAutoReset();
    });

    // 更新 Firebase 中的資料
    function updateRoomStatusInDB(newStatus) {
      set(roomStatusRef, newStatus);
    }
    function updateRoomGroupsInDB(newGroups) {
      set(roomGroupsRef, newGroups);
    }
    function updateSettingsInDB(newSettings) {
      set(settingsRef, newSettings);
    }

    /********** 其他設定 **********/
    let isAdminMode = false;
    const defaultRooms = [
      "1A1",
      "3A1", "3A2", "3B1", "3B2", "3C1", "3C2",
      "4A1", "4A2", "4B1", "4B2", "4C1", "4C2", "4D1",
      "5A", "5B", "5C", "5D", "5CVIA", "5CVIB",
      "6A", "6B", "6C", "6D",
      "7A", "7B", "7C", "7D",
      "8A", "8B", "8C", "8D",
      "9A", "9B", "9C", "9D",
      "11A", "11B", "11C", "11D",
      "12A", "12B", "12C", "12D",
      "13A", "13B", "13C", "13D",
      "14A", "14B", "14C", "14D",
      "15A", "15B", "15C"
    ];
    // 若 roomGroups 尚未設定，則以預設房間依樓層分組
    function getDefaultGroup() {
      const groups = {};
      defaultRooms.forEach(room => {
        const floor = getFloor(room);
        if (!groups[floor]) groups[floor] = [];
        groups[floor].push(room);
      });
      return groups;
    }

    // 當操作房間排序時，更新 Firebase roomGroups
    function updateGroups() {
      const groups = {};
      document.querySelectorAll(".floor-column").forEach(col => {
        const floor = col.getAttribute("data-floor");
        const container = col.querySelector(".button-container");
        const rooms = Array.from(container.children).map(div => div.getAttribute("data-room"));
        if (rooms.length > 0) {
          groups[floor] = rooms;
        }
      });
      updateRoomGroupsInDB(groups);
    }

    /********** 自動重設設定 **********/
    function checkAutoReset() {
      if (!settings.autoResetEnabled) return;
      const today = new Date().toISOString().slice(0,10);
      if (settings.lastResetDate !== today) {
        // 隔日
